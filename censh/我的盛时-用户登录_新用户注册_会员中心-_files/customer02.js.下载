window.onload = function () {
    $(function () {
        var uname = $("#uname");
        var ucode = $("#ucode");
        var submit = $("#submit");
        var uagree = $("#uagree");
        var getSMS = $("#getSMS");
        var pattern = /^1[0-9]{10}$/;
        var oldLogin = $('#oldLogin');
        var newLogin = $('#newLogin');
        var osubmit = $('#osubmit');
        var oname = $('#oname');
        var opwd = $('#opwd');
        var mode = $('.login-content-mode');
        var formKey = $('#form_key');


        // 验证手机
        function checkPhone() {
            if (uname.val() === '') {
                uname.parent().find('.login-content-inputBox-msg').addClass('error');
                uname.parent().find('.login-content-inputBox-msg').text("请输入手机号码");
                return false;
            }
            if (!pattern.test(uname.val())) {
                uname.parent().find('.login-content-inputBox-msg').addClass('error');
                uname.parent().find('.login-content-inputBox-msg').text("请输入正确的手机号码");
                return false;
            }
            uname.parent().find('.login-content-inputBox-msg').removeClass('error');
            uname.parent().find('.login-content-inputBox-msg').text("");
            return true;
        }

        function checkPhone_old() {
            if (oname.val() === '') {
                oname.parent().find('.login-content-inputBox-msg').addClass('error');
                oname.parent().find('.login-content-inputBox-msg').text("请输入手机号码");
                return false;
            }
            if (!pattern.test(oname.val())) {
                oname.parent().find('.login-content-inputBox-msg').addClass('error');
                oname.parent().find('.login-content-inputBox-msg').text("请输入正确的手机号码");
                return false;
            }
            oname.parent().find('.login-content-inputBox-msg').removeClass('error');
            oname.parent().find('.login-content-inputBox-msg').text("");
            return true;
        }

        //验证间隔
        function resetCode(n) {
            getSMS.attr("disabled", "disabled");
            getSMS.addClass('disabled');
            var second = n || 60;
            getSMS.val(second + "秒后重新发送");
            var timer = window.setInterval(function () {
                if (second > 1) {
                    second--;
                    getSMS.val(second + "秒后重新发送");
                } else {
                    if (window.localStorage) {
                        window.localStorage.removeItem('timer');
                    }
                    window.clearInterval(timer);
                    getSMS.removeAttr("disabled", "disabled");
                    getSMS.removeClass('disabled');
                    second = 60;
                    getSMS.val("获取验证码");
                    uname.parent().find('.login-content-inputBox-msg').removeClass('error');
                    uname.parent().find('.login-content-inputBox-msg').text("");
                }
            }, 1000);
        }

        //获取短信验证码
        function getSMSCode() {
            point_click('获取验证码');
            if (checkPhone()) {
                uname.parent().find('.login-content-inputBox-msg').removeClass('error');
                uname.parent().find('.login-content-inputBox-msg').text("");
                ucode.parent().find('.login-content-inputBox-msg').removeClass('error');
                ucode.parent().find('.login-content-inputBox-msg').text("");

                $.ajax({
                    url: '/customer/getRegisterSmsCode',
                    dataType: 'json',
                    type: 'post',
                    data: {
                        type: "fast",
                        phone: uname.val(),
                        form_key: formKey.val()
                    },
                    success: function (data) {
                        if (data.result === 1) {
                            if (window.localStorage) {
                                window.localStorage.setItem('timer', Math.round(new Date().getTime() / 1000));
                            }
                            resetCode();
                        } else {
                            uname.parent().find('.login-content-inputBox-msg').addClass('error');
                            uname.parent().find('.login-content-inputBox-msg').text(data.message);
                        }
                    }
                });
            }
        }

        //验证验证码
        function checkCode() {
            if (ucode.val() === '') {
                ucode.parent().find('.login-content-inputBox-msg').addClass('error');
                ucode.parent().find('.login-content-inputBox-msg').text("请输入短信验证码");
                return false;
            }
            if (ucode.val().length < 6) {
                ucode.parent().find('.login-content-inputBox-msg').addClass('error');
                ucode.parent().find('.login-content-inputBox-msg').text("短信验证码不能小于6位");
                return false;
            }

            ucode.parent().find('.login-content-inputBox-msg').removeClass('error');
            ucode.parent().find('.login-content-inputBox-msg').text("");
            return true;
        }

        //验证密码
        function checkPassword() {
            if (opwd.val() === '') {
                opwd.parent().find('.login-content-inputBox-msg').addClass('error');
                opwd.parent().find('.login-content-inputBox-msg').text("请输入密码");
                return false;
            }
            if (opwd.val().length < 6) {
                opwd.parent().find('.login-content-inputBox-msg').addClass('error');
                opwd.parent().find('.login-content-inputBox-msg').text("密码不能小于6位");
                return false;
            }
            opwd.parent().find('.login-content-inputBox-msg').removeClass('error');
            opwd.parent().find('.login-content-inputBox-msg').text("");
            return true;
        }

        //快速登陆
        function userSubmit() {
            point_click('注册登录');
            if (uagree.is(":checked")) {
                if (checkPhone() && checkCode()) {
                    $.ajax({
                        url: '/customer/loginPost',
                        dataType: 'json',
                        type: 'post',
                        data: {
                            type: "fast",
                            username: uname.val(),
                            verify_code: ucode.val()
                        },
                        success: function (data) {
                            if (data.error === 0) {
                                window.location.href = data.redirect;
                            } else {
                                ucode.parent().find('.login-content-inputBox-msg').addClass('error');
                                ucode.parent().find('.login-content-inputBox-msg').text(data.msg);
                            }
                        }
                    });
                }
            } else {
                alert("请勾选注册协议");
            }
        }

        //密码登陆
        function userSubmit_old() {
            if (checkPhone_old() && checkPassword()) {
                $.ajax({
                    url: '/customer/loginPost',
                    dataType: 'json',
                    type: 'post',
                    data: {
                        type: "normal",
                        username: oname.val(),
                        password: opwd.val()
                    },
                    success: function (data) {
                        if (data.error === 0) {
                            window.location.href = data.redirect;
                        } else {
                            oname.parent().find('.login-content-inputBox-msg').addClass('error');
                            oname.parent().find('.login-content-inputBox-msg').text(data.msg);
                        }
                    }
                });
            }
        }

        if (window.localStorage) {
            if (window.localStorage.getItem('timer')) {
                var resetTime = Math.round(new Date().getTime() / 1000) - Number(window.localStorage.getItem('timer'));
                if (resetTime < 60) {
                    resetCode(60 - resetTime)
                }
            }
        }

        getSMS.on("click", function () {
            getSMSCode()
        });

        submit.on("click", function () {
            userSubmit()
        });

        osubmit.on("click", function () {
            userSubmit_old()
        });

        oldLogin.on("click", function () {
            newLogin.removeClass('on');
            oldLogin.addClass('on');
            if (!mode.hasClass('old')) {
                mode.addClass('old')
            }
        });

        newLogin.on("click", function () {
            oldLogin.removeClass('on');
            newLogin.addClass('on');
            if (mode.hasClass('old')) {
                mode.removeClass('old')
            }
        });

        //第三方登录
        $("#wbLoginBtn").on('click', function () {
            window.location.href = "/customer/redirectToSocial?channel=weibo&social_action=login";
        });

        $("#qqLoginBtn").on('click', function () {
            window.location.href = "/customer/redirectToSocial?channel=qq&social_action=login";
        });

        $("#wxLoginBtn").on('click', function () {
            window.location.href = "/customer/redirectToSocial?channel=wechat&social_action=login";
        });

        //回车键
        $(window).on("keydown", function (e) {
            if (e.which === 13) {
                e.preventDefault();
                if (oldLogin.hasClass('on')) {
                    userSubmit_old()
                } else {
                    userSubmit()
                }
            }
        })
    });
};
